@{ 
 Layout = "~/Views/Shared/_Layout.cshtml";
 ViewBag.Title = "系统用户信息";
 }

@*脚本引用放在此处可以实现自定义函数自动提示*@
<script src="~/Scripts/CommonUtil.js"></script>

<div class="portlet box green-meadow col-md-3">
    <div class="portlet-title">
        <div class="caption">
            <i class="fa fa-filter"></i>用户分类
        </div>
    </div>
    <div class="portlet-body flip-scroll">
        <ul class="nav nav-tabs">
            <li class="active">
                <a href="#tab_1_1" data-toggle="tab">按组织机构查看</a>
            </li>
            <li>
                <a href="#tab_1_2" data-toggle="tab">按角色查看</a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade active in" id="tab_1_1">
                <div class="row" style="padding-left:20px">
                    <div id="jstree_div"></div>
                 </div>
            </div>
            <div class="tab-pane fade" id="tab_1_2">
                <div class="row" style="padding-left:20px">
                    <div id="jstree_role"></div>
                 </div>
            </div>
        </div>
    </div>
</div>

<div class="portlet box col-md-9">
    <div class="portlet-body flip-scroll" style="width:99%">
        <!-- BEGIN 数据查询-->
        <div class="portlet box green-meadow">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-filter"></i>查询内容
                </div>
                <div class="tools">
                    <button type="button" class="btn btn-circle btn-sm green" onclick="Refresh()">
                        <i class="fa fa-search"></i>
                        查 询
                    </button>
                    <button type="button" class="btn btn-circle btn-sm green" onclick="ShowImport()">
                        <i class="fa fa-file-excel-o"></i>
                        导 入
                    </button>
                    <button type="button" class="btn btn-circle btn-sm green" onclick="ShowExport()">
                        <i class="fa fa-file-excel-o"></i>
                        导 出
                    </button>
                    <button type="button" class="btn btn-circle btn-sm green" onclick="javascript:location.href='/User/RDLCReport';">
                        <i class="fa fa-file-excel-o"></i>
                        RDLC报表
                    </button>
                    <a href="javascript:;" class="collapse" title="折叠内容"></a>
                </div>
            </div>

            <div class="portlet-body flip-scroll">
                <form class="form-horizontal" id="ffSearch">
                    <div class="row">
                        <div class="col-md-4 col-sm-4 col-xs-6">
                            <div class="form-group">
                                <label class="control-label col-md-4">用户编码</label>
                                <div class="col-md-8">
                                    <input name="WHC_HandNo" type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-4 col-xs-6">
                            <div class="form-group">
                                <label class="control-label col-md-4">用户名</label>
                                <div class="col-md-8">
                                    <input name="WHC_Name" type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-4 col-xs-6">
                            <div class="form-group">
                                <label class="control-label col-md-4">真实姓名</label>
                                <div class="col-md-8">
                                    <input name="WHC_FullName" type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 col-sm-4 col-xs-6">
                            <div class="form-group">
                                <label class="control-label col-md-4">移动电话</label>
                                <div class="col-md-8">
                                    <input name="WHC_MobilePhone" type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-4 col-xs-6">
                            <div class="form-group">
                                <label class="control-label col-md-4">邮件地址</label>
                                <div class="col-md-8">
                                    <input name="WHC_Email" type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-4 col-xs-6">
                            <div class="form-group">
                                <label class="control-label col-md-4">QQ号码</label>
                                <div class="col-md-8">
                                    <input name="WHC_QQ" type="text" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <!-- END 数据查询-->
        <!-- BEGIN 表格数据-->
        <div class="portlet box green-meadow">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-cogs"></i>数据列表
                </div>
                <div class="tools">
                    <button type="button" onclick="Add()" class="btn btn-circle btn-sm green-meadow">
                        <i class="fa fa-plus"></i> 新增
                    </button>
                    <button type="button" onclick="EditView()" class="btn btn-circle btn-sm green-meadow">
                        <i class="fa fa-pencil"></i> 修改
                    </button>
                    <button type="button" onclick="EditView('view')" class="btn btn-circle btn-sm green-meadow">
                        <i class="fa fa-table"></i> 查看
                    </button>
                    <button type="button" onclick="Delete()" class="btn btn-circle btn-sm green-meadow">
                        <i class="fa fa-minus"></i> 删除
                    </button>
                    <button type="button" onclick="Refresh()" class="btn btn-circle btn-sm green-meadow" data-toggle="modal">
                        <i class="fa fa-refresh"></i> 刷新
                    </button>
                    <button type="button" class="fullscreen btn btn-circle btn-sm green-meadow" data-original-title="全屏">
                        <i class="icon-size-fullscreen"></i>
                    </button>
                </div>
            </div>
            <div class="portlet-body flip-scroll">
                <div class="portlet-body">
                    <div>
                        <span>每页显示</span>
                        <select id="rows" onchange="ChangeRows()">
                            <option>10</option>
                            <option>50</option>
                            <option>100</option>
                            <option>1000</option>
                        </select>
                        <span>条记录</span>&nbsp;&nbsp;
                        <span>共有记录：</span><span id='totalCount' class="label label-success">0</span>条，总页数：<span id='totalPageCount' class="label label-success">0</span>页。
                    </div>
                    <hr />
                    <table id="grid" class="table table-striped table-bordered table-hover" cellpadding="0" cellspacing="0" border="0" class="display" width="100%">
                        <thead id="grid_head">
                            <tr>
                                <th class="table-checkbox" style="width:40px"><input class="group-checkable" type="checkbox" onclick="selectAll(this)"></th>
                                <th>ID</th>
                                <th>用户编码</th>
                                <th>用户名/登录名</th>
                                <th>真实姓名</th>
                                <th>是否过期</th>
                                <th>是否删除</th>
                                @*<th>职务头衔</th>*@
                                <th>移动电话</th>
                                @*<th>办公电话</th>*@
                                <th>邮件地址</th>
                                <th>性别</th>
                                <th></th>
                                <th style="width:90px">操作</th>
                            </tr>
                        </thead>
                        <tbody id="grid_body"></tbody>
                    </table>
                    <div class="paging-toolbar">
                        <ul id='grid_paging'></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--------------------------添加信息的弹出层---------------------------->
<div class="modal fade" id="add" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg bs-modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">
                    <i class="fa fa-plus"></i>
                    <span id="lblAddTitle" style="font-weight:bold">添加信息</span>
                </h4>
            </div>
            <form class="form-horizontal" id="ffAdd" action="">
                <div class="modal-body">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a href="#tab_2_1" data-toggle="tab">基础信息</a>
                        </li>
                        <li>
                            <a href="#tab_2_2" data-toggle="tab">肖像信息</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade active in" id="tab_2_1">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">用户名/登录名<span class="required">*</span></label>
                                        <div class="input-icon col-md-8">                                            
                                            <input id="Name" name="Name" type="text" class="form-control" placeholder="用户名..." required>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">真实姓名<span class="required">*</span></label>
                                        <div class="input-icon col-md-8">                                            
                                            <input id="FullName" name="FullName" type="text" class="form-control" placeholder="真实姓名..." required>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">所属公司<span class="required">*</span></label>
                                        <div class="input-icon col-md-8">                                            
                                            <select id="Company_ID" name="Company_ID" class="form-control select2" placeholder="所属公司..." required></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">默认部门<span class="required">*</span></label>
                                        <div class="input-icon col-md-8">                                            
                                            <select id="Dept_ID" name="Dept_ID" class="form-control select2" placeholder="默认部门..." required></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">所属经理</label>
                                        <div class="input-icon col-md-8">                                    
                                            <select id="PID" name="PID" class="form-control select2" placeholder="所属经理..."></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">职务头衔</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="Title" name="Title" type="text" class="form-control" placeholder="职务头衔...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">用户编码</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="UserCode" name="UserCode" type="text" class="form-control" placeholder="用户编码..." >
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">排序</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="SortCode" name="SortCode" type="text" class="form-control" placeholder="排序..." >
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">用户呢称</label>
                                        <div class="input-icon col-md-8">
                                            
                                            <input id="LoginName" name="LoginName" type="text" class="form-control" placeholder="用户呢称...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">QQ号码</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="QQ" name="QQ" type="text" class="form-control" placeholder="QQ号码...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">邮件地址</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="Email" name="Email" type="email" class="form-control" placeholder="邮件地址...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">移动电话</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="MobilePhone" name="MobilePhone" type="text" class="form-control" placeholder="移动电话...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">身份证号码</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="IdentityCard" name="IdentityCard" type="text" class="form-control" placeholder="身份证号码...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">性别</label>
                                        <div class="input-icon col-md-8">                                    
                                            <label class="icheck-inline">
                                                <input type="radio" name="Gender" value="男" checked class="icheck" />
                                                男
                                            </label>
                                            <label class="icheck-inline">
                                                <input type="radio" name="Gender" value="女" class="icheck" />
                                                女
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">出生日期</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="Birthday" name="Birthday" type="date" class="form-control" placeholder="出生日期...">
                                        </div>
                                    </div>
                                </div>
                                 <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">办公电话</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="OfficePhone" name="OfficePhone" type="text" class="form-control" placeholder="办公电话...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">家庭电话</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="HomePhone" name="HomePhone" type="text" class="form-control" placeholder="家庭电话..." >
                                        </div>
                                    </div>
                                </div>
                                 <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">家庭住址</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="Address" name="Address" type="text" class="form-control" placeholder="家庭住址..." >
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="control-label col-md-2">办公地址</label>
                                        <div class="input-icon col-md-10">                                    
                                            <input id="WorkAddr" name="WorkAddr" type="text" class="form-control" placeholder="办公地址..." >
                                        </div>
                                    </div>
                                </div>
                                  <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="control-label col-md-2">个性签名</label>
                                        <div class="input-icon col-md-10">                                    
                                            <textarea id="Signature" name="Signature" class="form-control" placeholder="个性签名..."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="control-label col-md-2">备注</label>
                                        <div class="input-icon col-md-10">                                    
                                            <textarea id="Note" name="Note"class="form-control" placeholder="备注..." ></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab_2_2">
                            <div class="row" style="height: 500px">
                                <input id="file-Portrait" type="file">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-info">
                    <input type="hidden" id="ID" name="ID" />
                    <button type="submit" class="btn blue">确定</button>
                    <button type="button" class="btn green" data-dismiss="modal">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--------------------------编辑信息的弹出层---------------------------->
<div class="modal fade" id="edit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg bs-modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">
                    <i class="icon-pencil"></i>
                    <span id="lblEditTitle" style="font-weight:bold">修改信息</span>
                </h4>
            </div>
            <form class="form-horizontal" id="ffEdit" action="">
                <div class="modal-body">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a href="#tab_3_1" data-toggle="tab">基础信息</a>
                        </li>
                         <li>
                            <a href="#tab_3_2" data-toggle="tab">用户可操作功能</a>
                        </li>                        
                        <li>
                            <a href="#tab_3_3" data-toggle="tab">所属机构角色</a>
                        </li>
                        <li>
                            <a href="#tab_3_4" data-toggle="tab">肖像信息</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade active in" id="tab_3_1">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">用户名/登录名<span class="required">*</span></label>
                                        <div class="input-icon col-md-8">                                            
                                            <input id="Name1" name="Name" type="text" class="form-control" placeholder="用户名..." required>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">真实姓名<span class="required">*</span></label>
                                        <div class="input-icon col-md-8">                                            
                                            <input id="FullName1" name="FullName" type="text" class="form-control" placeholder="真实姓名..." required>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">所属公司<span class="required">*</span></label>
                                        <div class="input-icon col-md-8">                                            
                                            <select id="Company_ID1" name="Company_ID" class="form-control select2" placeholder="所属公司..." required></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">默认部门<span class="required">*</span></label>
                                        <div class="input-icon col-md-8">                                            
                                            <select id="Dept_ID1" name="Dept_ID" class="form-control select2" placeholder="默认部门..." required></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">所属经理</label>
                                        <div class="input-icon col-md-8">                                    
                                            <select id="PID1" name="PID" class="form-control select2" placeholder="所属经理..."></select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">职务头衔</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="Title1" name="Title" type="text" class="form-control" placeholder="职务头衔...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">用户编码</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="HandNo1" name="UserCode" type="text" class="form-control" placeholder="用户编码..." >
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">排序</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="SortCode1" name="SortCode" type="text" class="form-control" placeholder="排序..." >
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">用户呢称</label>
                                        <div class="input-icon col-md-8">
                                            
                                            <input id="Nickname1" name="LoginName" type="text" class="form-control" placeholder="用户呢称...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">QQ号码</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="QQ1" name="QQ" type="text" class="form-control" placeholder="QQ号码...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">邮件地址</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="Email1" name="Email" type="email" class="form-control" placeholder="邮件地址...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">移动电话</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="MobilePhone1" name="MobilePhone" type="text" class="form-control" placeholder="移动电话...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">身份证号码</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="IdentityCard1" name="IdentityCard" type="text" class="form-control" placeholder="身份证号码...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">性别</label>
                                        <div class="input-icon col-md-8">                                    
                                            <label class="icheck-inline">
                                                <input type="radio" name="Gender" value="男" checked class="icheck" />
                                                男
                                            </label>
                                            <label class="icheck-inline">
                                                <input type="radio" name="Gender" value="女" class="icheck" />
                                                女
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">出生日期</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="Birthday1" name="Birthday" type="date" class="form-control" placeholder="出生日期...">
                                        </div>
                                    </div>
                                </div>
                                 <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">办公电话</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="OfficePhone1" name="OfficePhone" type="text" class="form-control" placeholder="办公电话...">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">家庭电话</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="HomePhone1" name="HomePhone" type="text" class="form-control" placeholder="家庭电话..." >
                                        </div>
                                    </div>
                                </div>
                                 <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">家庭住址</label>
                                        <div class="input-icon col-md-8">                                    
                                            <input id="Address1" name="Address" type="text" class="form-control" placeholder="家庭住址..." >
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="control-label col-md-2">办公地址</label>
                                        <div class="input-icon col-md-10">                                    
                                            <input id="WorkAddr1" name="WorkAddr" type="text" class="form-control" placeholder="办公地址..." >
                                        </div>
                                    </div>
                                </div>
                                  <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="control-label col-md-2">个性签名</label>
                                        <div class="input-icon col-md-10">                                    
                                            <textarea id="Signature1" name="Signature" class="form-control" placeholder="个性签名..."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="control-label col-md-2">备注</label>
                                        <div class="input-icon col-md-10">                                    
                                            <textarea id="Note1" name="Note"class="form-control" placeholder="备注..." ></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab_3_2">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <i class="fa fa-gift"></i>
                                    </div>
                                    <div class="actions">
                                        <a class="btn btn-icon-only btn-default btn-sm fullscreen" href="#" data-original-title="" title="">
                                        </a>
                                    </div>
                                </div>
                                <div class="portlet-body">
                                    <div class="scroller" style="height:500px" data-rail-visible="1" data-rail-color="yellow" data-handle-color="#a1b2bd">
                                        <div id="jstree_function"></div>
                                    </div>
                                </div>
                            </div>
                        </div>                        
                        <div class="tab-pane fade" id="tab_3_3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="portlet box blue ">
                                        <div class="portlet-title">
                                            <div class="caption">
                                                <i class="fa fa-gift"></i>用户所属机构
                                            </div>
                                            <div class="actions">
                                                <a class="btn btn-icon-only btn-default btn-sm fullscreen" href="#" data-original-title="" title="">
                                                </a>
                                            </div>
                                        </div>
                                        <div class="portlet-body">
                                            <div class="scroller" style="height:500px" data-rail-visible="1" data-rail-color="yellow" data-handle-color="#a1b2bd">
                                                <select id="lbxOUs" multiple  class="form-control" style="height:100%;width=100%"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="portlet box blue">
                                        <div class="portlet-title">
                                            <div class="caption">
                                                <i class="fa fa-gift"></i>用户所属角色
                                            </div>
                                            <div class="actions">
                                                <a class="btn btn-icon-only btn-default btn-sm fullscreen" href="#" data-original-title="" title="">
                                                </a>
                                            </div>
                                        </div>
                                        <div class="portlet-body">
                                            <div class="scroller" style="height:500px" data-rail-visible="1" data-rail-color="yellow" data-handle-color="#a1b2bd">
                                                <select id="lbxRoles" multiple  class="form-control" style="height:100%;width=100%" ></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab_3_4">
                            <div class="row" style="height: 500px">
                                <input id="file-Portrait1" type="file">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-info">
                    <input type="hidden" id="ID1" name="ID" />
                    <button type="submit" class="btn blue">确定</button>
                    <button type="button" class="btn green" data-dismiss="modal">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--------------------------查看信息的弹出层---------------------------->
<div class="modal fade" id="view" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg bs-modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">
                    <i class="icon-book-open"></i>
                    <span style="font-weight:bold">查看信息</span>
                </h4>
            </div>
            <form class="form-horizontal" id="ffView" action="">
                <div class="modal-body">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a href="#tab_4_1" data-toggle="tab">基础信息</a>
                        </li>
                         <li>
                            <a href="#tab_4_2" data-toggle="tab">用户可操作功能</a>
                        </li>                        
                        <li>
                            <a href="#tab_4_3" data-toggle="tab">所属机构角色</a>
                        </li>
                        <li>
                            <a href="#tab_4_4" data-toggle="tab">肖像信息</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade active in" id="tab_4_1">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">用户名/登录名</label>
                                        <div class="col-md-8">                                            
                                            <label id="Name2" name="Name" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">真实姓名</label>
                                        <div class="col-md-8">                                            
                                            <label id="FullName2" name="FullName" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">所属公司</label>
                                        <div class="col-md-8">                                            
                                            <label id="Company_ID2" name="Company_ID" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">默认部门</label>
                                        <div class="col-md-8">                                            
                                            <label id="Dept_ID2" name="Dept_ID" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">所属经理</label>
                                        <div class="col-md-8">                                    
                                            <label id="PID2" name="PID" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">职务头衔</label>
                                        <div class="col-md-8">                                    
                                            <label id="Title2" name="Title" class="form-control"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">用户编码</label>
                                        <div class="col-md-8">                                    
                                            <label id="HandNo2" name="UserCode" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">排序</label>
                                        <div class="col-md-8">                                    
                                            <label id="SortCode2" name="SortCode" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">用户呢称</label>
                                        <div class="col-md-8">                                            
                                            <label id="Nickname2" name="LoginName" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">QQ号码</label>
                                        <div class="col-md-8">                                    
                                            <label id="QQ2" name="QQ" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">邮件地址</label>
                                        <div class="col-md-8">                                    
                                            <label id="Email2" name="Email" type="email" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">移动电话</label>
                                        <div class="col-md-8">                                    
                                            <label id="MobilePhone2" name="MobilePhone" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">身份证号码</label>
                                        <div class="col-md-8">                                    
                                            <label id="IdentityCard2" name="IdentityCard" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">性别</label>
                                        <div class="col-md-8">         
                                            <label id="Gender2" name="Gender" class="form-control" />     
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">出生日期</label>
                                        <div class="col-md-8">                                    
                                            <label id="Birthday2" name="Birthday" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                 <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">办公电话</label>
                                        <div class="col-md-8">                                    
                                            <label id="OfficePhone2" name="OfficePhone" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">家庭电话</label>
                                        <div class="col-md-8">                                    
                                            <label id="HomePhone2" name="HomePhone" class="form-control" / >
                                        </div>
                                    </div>
                                </div>
                                 <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label col-md-4">家庭住址</label>
                                        <div class="col-md-8">                                    
                                            <label id="Address2" name="Address" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="control-label col-md-2">办公地址</label>
                                        <div class="col-md-10">                                    
                                            <label id="WorkAddr2" name="WorkAddr" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                  <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="control-label col-md-2">个性签名</label>
                                        <div class="col-md-10">                                    
                                            <label id="Signature2" name="Signature" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="control-label col-md-2">备注</label>
                                        <div class="col-md-10">                                    
                                            <label id="Note2" name="Note"class="form-control" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab_4_2">
                            <div class="portlet box blue">
                                <div class="portlet-title">
                                    <div class="caption">
                                        <i class="fa fa-gift"></i>
                                    </div>
                                    <div class="actions">
                                        <a class="btn btn-icon-only btn-default btn-sm fullscreen" href="#" data-original-title="" title="">
                                        </a>
                                    </div>
                                </div>
                                <div class="portlet-body">
                                    <div class="scroller" style="height:500px" data-rail-visible="1" data-rail-color="yellow" data-handle-color="#a1b2bd">
                                        <div id="jstree_function2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>                        
                        <div class="tab-pane fade" id="tab_4_3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="portlet box blue ">
                                        <div class="portlet-title">
                                            <div class="caption">
                                                <i class="fa fa-gift"></i>用户所属机构
                                            </div>
                                            <div class="actions">
                                                <a class="btn btn-icon-only btn-default btn-sm fullscreen" href="#" data-original-title="" title="">
                                                </a>
                                            </div>
                                        </div>
                                        <div class="portlet-body">
                                            <div class="scroller" style="height:500px" data-rail-visible="1" data-rail-color="yellow" data-handle-color="#a1b2bd">
                                                <select id="lbxOUs2" multiple  class="form-control" style="height:100%;width=100%"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="portlet box blue">
                                        <div class="portlet-title">
                                            <div class="caption">
                                                <i class="fa fa-gift"></i>用户所属角色
                                            </div>
                                            <div class="actions">
                                                <a class="btn btn-icon-only btn-default btn-sm fullscreen" href="#" data-original-title="" title="">
                                                </a>
                                            </div>
                                        </div>
                                        <div class="portlet-body">
                                            <div class="scroller" style="height:500px" data-rail-visible="1" data-rail-color="yellow" data-handle-color="#a1b2bd">
                                                <select id="lbxRoles2" multiple  class="form-control" style="height:100%;width=100%" ></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab_4_4">
                            <div class="row" style="height: 500px">
                                <image src="" id="Portrait2"  style="max-height:128px;max-width=128px"/>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-info">
                    <input type="hidden" id="ID2" name="ID" />
                    <button type="button" class="btn green" data-dismiss="modal">关闭</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--导入数据操作层-->
<div id="import" class="modal fade bs-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">文件导入</h4>
            </div>
            <div class="modal-body">
                <div style="text-align:right;padding:5px">
                    <a href="~/Content/Template/User-模板.xls" onclick="javascript:Preview();">
                        <img alt="测试用户信息-模板" src="~/Content/images/ico_excel.png" />
                        <span style="font-size:larger;font-weight:200;color:red">User-模板.xls</span>
                    </a>
                </div>
                <hr/>
                <form id="ffImport" method="post">
                    <div title="Excel导入操作" style="padding: 5px" data-options="iconCls:'icon-key'">
                        <input class="easyui-validatebox" type="hidden" id="AttachGUID" name="AttachGUID" />    
                        <input id="file_upload" name="file_upload" type="file" multiple="multiple">                    
                        <a href="javascript:;" class="btn btn-primary" id="btnUpload" onclick="javascript: $('#file_upload').uploadify('upload', '*')">上传</a>
                        <a href="javascript:;" class="btn btn-default" id="btnCancelUpload" onclick="javascript: $('#file_upload').uploadify('cancel', '*')">取消</a>

                        <div id="fileQueue" class="fileQueue"></div>
                        <br />                    
                        <hr style="width:98%" />                    
                        <div id="div_files"></div>
                        <br />                    
                    </div>
                </form>

                <!--数据显示表格-->
                <table id="gridImport" class="table table-striped table-bordered table-hover" cellpadding="0" cellspacing="0" border="0" class="display" width="100%">
                    <thead id="gridImport_head">
                        <tr>
                            <th class="table-checkbox" style="width:40px"><input class="group-checkable" type="checkbox" onclick="selectAll(this)"></th>
                            <th>用户编码</th>
                            <th>用户名/登录名</th>
                            <th>真实姓名</th>
                            <th>职务头衔</th>
                            <th>移动电话</th>
                            <th>办公电话</th>
                            <th>邮件地址</th>
                            <th>性别</th>
                            <th>QQ号码</th>
                            <th>备注</th>
                        </tr>
                    </thead>
                    <tbody id="gridImport_body"></tbody>
                </table>
            </div>
            <div class="modal-footer bg-info">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="SaveImport()">保存</button>
            </div>
        </div>
    </div>
</div>

<!--选择导入用户的公司和部门-->
<div id="selectDept" class="modal fade bs-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form id="ffSelectDept" method="post">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">选择导入用户的公司和部门</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">所属公司<span class="required">*</span></label>
                                <div class="input-icon col-md-8">                                            
                                    <select id="Company_ID3" name="Company_ID" class="form-control select2" placeholder="所属公司..." required></select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="control-label col-md-4">默认部门<span class="required">*</span></label>
                                <div class="input-icon col-md-8">                                            
                                    <select id="Dept_ID3" name="Dept_ID" class="form-control select2" placeholder="默认部门..." required></select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn blue">确定</button>
                    <button type="button" class="btn green" data-dismiss="modal">取消</button>
                </div>
            </div>
        </form>
    </div>
</div>


@section footerScript{

<script type="text/javascript">
        var currentPage = 1, rows = 10; //分页参数：当前页，记录数

        var isAddOrEdit = 'add';//标识是新增还是编辑对话框弹出，用于删除附件的操作
        var url;//新增或者更新的连接
        var ID;//ID值，新增为空，编辑或者查看为具体ID

        //页面初始化
        $(function () {
            InitStyle();        //设置控件的样式
            initDeptTreeview(); //初始化部门树
            initRoleTree();     //初始化角色树

            BindEvent();        //绑定事件处理
            Search(currentPage);//初始化第一页数据
            InitDictItem();     //初始化字典信息
        });

        //设置控件的样式
        function InitStyle() {

            //统一设置icheck控件的样式
            $('input[class=icheck]').iCheck({
                checkboxClass: 'icheckbox_square-red',
                radioClass: 'iradio_square-red',
            });

            //初始化fileinput控件（第一次初始化）
            initFileInput("file-Portrait", "/User/EditPortrait");
            initFileInput("file-Portrait1", "/User/EditPortrait");
        }

        //初始化组织机构列表
        function initDeptTreeview() {
            var treeUrl = '/User/GetMyDeptJsTreeJson?userId=@Session["UserId"]';
            bindJsTree("jstree_div", treeUrl);

            //树控件的变化事件处理
            $('#jstree_div').on("changed.jstree", function (e, data) {
               var icon = data.node.icon;               
               loadDataByOu(data.selected);
            });
        }
        //初始化角色列表
        function initRoleTree() {
            var treeUrl = '/Role/GetMyRoleJsTreeJson?userId=@Session["UserId"]';
            bindJsTree("jstree_role", treeUrl);

            //树控件的变化事件处理
            $('#jstree_role').on("changed.jstree", function (e, data) {
               var id = data.selected + '';
               var dept = "dept";
               var role = "role"; 

               if (id.indexOf(dept) == 0) {
                    var newid = id.substring(dept.length, id.length);
                    loadDataByOu(newid);
                }
                else if (id.indexOf(role) == 0) {
                    var newid = id.substring(role.length, id.length);
                    loadDataByRole(newid);
                } 
            });            
        }

        //加载指定的对象数据
        var clickId = "";
        function loadDataByOu(id) {
            var condition = "Role_ID=&Dept_ID=" + id;            
            condition += appendCondition();
            SearchCondition(currentPage, condition);

            clickId = id;
        }
        //根据角色加载列表
        function loadDataByRole(id) {
            var condition = "Dept_ID=&Role_ID=" + id;            
            condition += appendCondition();
            SearchCondition(currentPage, condition);

            clickId = id;
        }

        //加上一些特殊条件
        function appendCondition() {
            var condition = "&WHC_Deleted=0";
            //如果不是超级管理员，只能看本公司的人员
            @if (Session["IsSuperAdmin"] == null || !(bool)Session["IsSuperAdmin"])
            {
                @Html.Raw("&WHC_Company_ID=" + Session["Company_ID"]);
            }
            return condition;
        }

        //根据条件查询并绑定结果
        function Search(page) {
            var condition = $("#ffSearch").serialize();
            condition += appendCondition();

            SearchCondition(page, condition);
        }
        function SearchCondition(page, condition) {

            url = "/User/FindWithPager?page=" + page + "&rows=" + rows;
            $.getJSON(url + "&" + condition, function (data) {
                $("#totalCount").text(data.total);
                $("#totalPageCount").text(Math.ceil(data.total / rows));

                $("#grid_body").html("");

                $.each(data.rows, function (i, item) {
                    var tr = "<tr>";
                    tr += "<td><input class='checkboxes' type=\"checkbox\" name=\"checkbox\" value=" + item.ID + "></td>";
                    tr += "<td>" + item.ID + "</td>";
                    tr += "<td>" + item.UserCode + "</td>";
                    tr += "<td>" + item.Name + "</td>";
                    tr += "<td>" + item.FullName + "</td>";      

                    if (item.IsExpire) {
                        //tr += "<td>" + item.Visible + "</td>";
                        tr += "<td><span class='label label-danger'>过期</span></td>";
                    } else {
                        tr += "<td><span class='label label-success'>正常</span></td>";
                    }

                    if (item.Deleted) {
                        //tr += "<td>" + item.Visible + "</td>";
                        tr += "<td><span class='label label-danger'>已删除</span></td>";
                    } else {
                        tr += "<td><span class='label label-success'>正常</span></td>";
                    } 
                                      
                    //tr += "<td>" + item.Title + "</td>";
                    tr += "<td>" + item.MobilePhone + "</td>";
                    //tr += "<td>" + item.OfficePhone + "</td>";
                    tr += "<td>" + item.Email + "</td>";
                    tr += "<td>" + item.Gender + "</td>";
                    tr += "<td><a href='javascript:;' onclick=\"resetPassword('" + item.ID + "')\" title='重置密码'><span class='glyphicon glyphicon-lock'></span></a></td>";

                    tr += getActionHtml(item.ID);

                    tr += "</tr>";
                    $("#grid_body").append(tr);
                });

                var element = $('#grid_paging');
                if(data.total > 0) {
                    var options = {
                        bootstrapMajorVersion: 3,
                        currentPage: page,
                        numberOfPages: rows,
                        totalPages: Math.ceil(data.total / rows),
                        onPageChanged: function (event, oldPage, newPage) {
                            SearchCondition(newPage, condition); //页面变化时触发内容更新
                        }
                    }
                    element.bootstrapPaginator(options);
                } else {
                    element.html("");
                }
            });
        }

        //初始化用户密码
        function resetPassword(id) {
            if (id != 'undefined' && id != '') {
                swal({
                    title: "重置密码提示",
                    text: "您确认删除选定的记录吗？",
                    type: "warning", showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    cancelButtonText: "取消",
                    confirmButtonText: "是的，重置密码！",
                    closeOnConfirm: true
                }, function () {
                    var postData = { ID: id };
                    $.post('/User/ResetPassword?r=' + Math.random(), postData, function (json) {
                        var data = $.parseJSON(json);
                        if (data.Success) {
                            showTips("重置密码成功");
                        }
                        else {
                            showError("修改失败:" + data.ErrorMessage);
                        }
                    });
                });
            } else {
                showTips("请选择记录");
            }
        }

        //设置一页显示多少条
        function ChangeRows() {
            rows = $("#rows").val();
            Refresh();
        }

        //刷新列表
        function Refresh() {
            Search(currentPage);
        }

        //初始化字典信息（下拉列表）
        function InitDictItem() {
            //BindDictItem("Titles", "职称");
            //BindDictItem("Rank", "职务");

            $("#Title").select2({
                tags: ["总经理", "副总", "技术总监", "财务总监", "部门经理"]
            });
            $("#Title1").select2({
                tags: ["总经理", "副总", "技术总监", "财务总监", "部门经理"]
            });

            //绑定添加界面的公司、部门、直属经理
            BindSelect("Company_ID", "/User/GetMyCompanyDictJson?userId="+@Session["UserId"]);
            $("#Company_ID").on("change", function (e) {
                var companyid = $("#Company_ID").val();
                BindSelect("Dept_ID", "/User/GetDeptDictJson?parentId="+ companyid);
            });
            $("#Dept_ID").on("change", function (e) {
                var deptid = $("#Dept_ID").val();
                BindSelect("PID", "/User/GetUserDictJson?deptId="+ deptid);
            });

            //绑定编辑界面的公司、部门、直属经理
            BindSelect("Company_ID1", "/User/GetMyCompanyDictJson?userId="+@Session["UserId"]);
            $("#Company_ID1").on("change", function (e) {
                var companyid = $("#Company_ID1").val();
                BindSelect("Dept_ID1", "/User/GetDeptDictJson?parentId="+ companyid);
            });
            $("#Dept_ID1").on("change", function (e) {
                var deptid = $("#Dept_ID1").val();
                BindSelect("PID1", "/User/GetUserDictJson?deptId="+ deptid);
            });

            //绑定导入界面的公司、部门
            BindSelect("Company_ID3", "/User/GetMyCompanyDictJson?userId="+@Session["UserId"]);
            $("#Company_ID3").on("change", function (e) {
                var companyid = $("#Company_ID3").val();
                BindSelect("Dept_ID3", "/User/GetDeptDictJson?parentId="+ companyid);
            });            
        }

        //实现删除数据的方法
        function Delete() {
            var ids = "";//得到用户选择的数据的ID
            $("[name='checkbox']").each(function () {
                if ($(this).is(':checked'))
                    ids = $(this).val() + ",";
            });

            DeleteByIds(ids);
        }

        //删除指定的记录
        function DeleteByIds(ids) {
            if (ids != "") {
                showDelete(function () {
                    //最后去掉最后的逗号,
                    ids = ids.replace(/,\s*$/, '');

                    //然后发送异步请求的信息到后台删除数据
                    //ConfirmDeleteByIds 为彻底删除
                    var postData = { ids: ids };
                    $.post("/User/ConfirmDeleteByIds", postData, function (json) {
                        var data = $.parseJSON(json);
                        if (data.Success) {
                            showTips("删除选定的记录成功");
                            Refresh();//刷新页面数据
                        }
                        else {
                            showTips(data.ErrorMessage);
                        }
                    });
                });
            } else {
                showTips("请选择你要删除的数据");
            }
        }

        //初始化图像信息
        function initPortrait(ctrlName, id) {
            var control = $('#' + ctrlName); 
            var imageurl = '/User/GetPortrait?id=' + id +'&r=' + Math.random();

            //重要，需要更新控件的附加参数内容，以及图片初始化显示
            control.fileinput('refresh', {
                uploadExtraData: { id: id },
                initialPreview: [ //预览图片的设置
                    "<img src='" + imageurl + "' class='file-preview-image' alt='肖像图片' title='肖像图片'>",
                ],
             });
        }

        //弹出新增对话框
        function Add() {
            isAddOrEdit = 'add';//新增对话框标识
            //CKEDITOR.instances.Content.setData('');  //清空编辑器的数据
            $("#ffAdd")[0].reset();//清空上次输入
            $('#ffAdd').validate().resetForm();//去除验证信息

            url = '/User/Insert2';//使用写入后返回ID的做法，方便更新图形
            initPortrait('file-Portrait', -1);

            //初始化部分控件
            $('input[name="Gender"][value="男"]').iCheck('check');
            
            //清空Select2控件的值
            $("#PID").select2("val", "");
            $("#Company_ID").select2("val", "");
            $("#Dept_ID").select2("val", "");

            $("#lblAddTitle").text("添加信息");
            $("#add").modal("show");
        }

        //修改或查看明细信息（绑定显示数据）
        function EditView(view) {
            ID = "";//重置ID的值
            $("[name='checkbox']").each(function () {
                if ($(this).is(':checked')) {
                    ID = $(this).val();//首先取出来用户选择的数据的ID
                }
            });
            EditViewById(ID, view);
        }

        //编辑或者查看指定记录
        function EditViewById(ID, view) {
            if (ID == "") {
                showTips("请选择一条记录");
                return;
            }

            if (view == null) {
                //处理修改的信息
                $("#lblEditTitle").text("修改信息");
                $("#edit").modal("show");
                url = '/User/Update?ID=' + ID;
                //绑定修改详细信息的方法
                BindEditInfo(ID);
            }
            else {
                //处理查看详细
                $("#view").modal("show");
                //绑定查看详细信息方法
                BindViewInfo(ID);
            }
        }

        //绑定编辑详细信息的方法
        function BindEditInfo(ID) {
            //使用同步方式，使得联动的控件正常显示
            $.ajaxSettings.async = false;

            //首先用户发送一个异步请求去后台实现方法
            $.getJSON("/User/FindByID?r=" + Math.random() + "&id=" + ID, function (info) {
                
                $("#ID1").val(info.ID);                
                $("#HandNo1").val(info.UserCode);
                $("#Name1").val(info.Name);
                $("#FullName1").val(info.FullName);
                $("#Nickname1").val(info.LoginName);
                $("#Title1").val(info.Title);
                $("#IdentityCard1").val(info.IdentityCard);
                $("#MobilePhone1").val(info.MobilePhone);
                $("#OfficePhone1").val(info.OfficePhone);
                $("#HomePhone1").val(info.HomePhone);
                $("#Email1").val(info.Email);
                $("#Address1").val(info.Address);
                $("#WorkAddr1").val(info.WorkAddr);
                // $("#Gender1").val(info.Gender);
                $("#Birthday1").val(getDateStr(info.Birthday));
                $("#QQ1").val(info.QQ);
                $("#Signature1").val(info.Signature);
                $("#Note1").val(info.Note);
                $("#CustomField1").val(info.CustomField);
                $("#SortCode1").val(info.SortCode);

                $("input[name='Gender']").iCheck('uncheck');
                $("input[name='Gender'][value='" + info.Gender + "']").iCheck('check');

                $("#Company_ID1").select2("val", info.Company_ID).trigger('change');
                $("#Dept_ID1").select2("val", info.Dept_ID).trigger('change');
                $("#PID1").select2("val", info.PID);

                initPortrait('file-Portrait1', ID);

                var treeUrl = '/Function/GetFunctionJsTreeJsonByUser?userId=' + info.ID;
                bindJsTree("jstree_function", treeUrl);

                $('#lbxRoles').empty();
                $.getJSON("/Role/GetRolesByUser?r=" + Math.random() + "&userid=" + info.ID, function (json) {
                    $.each(json, function (i, item) {
                        $('#lbxRoles').append('<option value="' + item.ID + '">' + item.Name + '</option>');
                    });
                });

                $('#lbxOUs').empty();
                $.getJSON("/Ou/GetOUsByUser?r=" + Math.random() + "&userid=" + info.ID, function (json) {
                    $.each(json, function (i, item) {
                        $('#lbxOUs').append('<option value="' + item.ID + '">' + item.Name + '</option>');
                    });
                });

                isAddOrEdit = 'edit';//新增对话框标识
            });
        }

        //绑定查看详细信息的方法
        function BindViewInfo(ID) {
            //发送请求
            $.getJSON("/User/FindByID?r=" + Math.random() + "&id=" + ID, function (info) {
                $("#ID2").text(info.ID);
                $("#HandNo2").text(info.UserCode);
                $("#Name2").text(info.Name);
                $("#FullName2").text(info.FullName);
                $("#Nickname2").text(info.LoginName);
                $("#Title2").text(info.Title);
                $("#IdentityCard2").text(info.IdentityCard);
                $("#MobilePhone2").text(info.MobilePhone);
                $("#OfficePhone2").text(info.OfficePhone);
                $("#HomePhone2").text(info.HomePhone);
                $("#Email2").text(info.Email);
                $("#Address2").text(info.Address);
                $("#WorkAddr2").text(info.WorkAddr);
                $("#Gender2").text(info.Gender);
                $("#Birthday2").text(getDateStr(info.Birthday));
                $("#QQ2").text(info.QQ);
                $("#Signature2").text(info.Signature);
                $("#Note2").text(info.Note);
                $("#CustomField2").text(info.CustomField);
                $("#SortCode2").text(info.SortCode);

                $("#Dept_ID2").text(info.DeptName);
                $("#Company_ID2").text(info.CompanyName);

                $('#lbxRoles2').empty();
                $.getJSON("/Role/GetRolesByUser?r=" + Math.random() + "&userid=" + info.ID, function (json) {
                    $.each(json, function (i, item) {
                        $('#lbxRoles2').append('<option value="' + item.ID + '">' + item.Name + '</option>');
                    });
                });

                $('#lbxOUs2').empty();
                $.getJSON("/Ou/GetOUsByUser?r=" + Math.random() + "&userid=" + info.ID, function (json) {
                    $.each(json, function (i, item) {
                        $('#lbxOUs2').append('<option value="' + item.ID + '">' + item.Name + '</option>');
                    });
                });

                $('#PID2').text("无");
                $.getJSON("/User/FindByID?r=" + Math.random() + "&id=" + info.PID, function (parentInfo) {
                    if (parentInfo != undefined) {
                        $('#PID2').val(parentInfo.Name);
                    }
                });

                var imageUrl = '/User/GetPortrait?id=' + ID +'&r=' + Math.random();
                $("#Portrait2").attr('src', imageUrl);

                var treeUrl = '/Function/GetFunctionJsTreeJsonByUser?userId=' + info.ID;
                bindJsTree("jstree_function2", treeUrl);
            });
        }

        //显示导入界面
        function ShowImport() {
            $("#import").modal("show");
        }

        //导出Excel数据
        function ShowExport() {
            var url = "/User/Export";
            var condition = $("#ffSearch").serialize();//获取条件

            executeExport(url, condition);//执行导出
        }

        //绑定相关事件
        function BindEvent() {
            //添加记录的窗体处理
            formValidate("ffAdd", function (form) {
                $("#add").modal("hide");
                //构造参数发送给后台
                var postData = $("#ffAdd").serializeArray();
                $.post(url, postData, function (json) {
                    var data = $.parseJSON(json);
                    if (data.Success) {
                        //增加肖像的上传处理
                        initPortrait(data.Data1);//使用写入的ID进行更新
                        $('#file-Portrait').fileinput('upload');

                        //保存成功  1.关闭弹出层，2.刷新表格数据
                        showTips("保存成功");
                        Refresh();
                    }
                    else {
                        showError("保存失败:" + data.ErrorMessage, 3000);
                    }
                }).error(function () {
                    showTips("您未被授权使用该功能，请联系管理员进行处理。");
                });
            });

            //编辑记录的窗体处理
            formValidate("ffEdit", function (form) {
                $("#edit").modal("hide");
                //构造参数发送给后台
                var postData = $("#ffEdit").serializeArray();
                $.post(url, postData, function (json) {
                    var data = $.parseJSON(json);
                    if (data.Success) {
                        //增加肖像的上传处理
                        $('#file-Portrait1').fileinput('upload');

                        //保存成功  1.关闭弹出层，2.刷新表格数据
                        showTips("保存成功");
                        Refresh();
                    }
                    else {
                        showError("保存失败:" + data.ErrorMessage, 3000);
                    }
                }).error(function () {
                    showTips("您未被授权使用该功能，请联系管理员进行处理。");
                });
            });  

            //选择公司、部门的窗体处理
            formValidate("ffSelectDept", function (form) {
                $("#selectDept").modal("hide");
                //构造参数发送给后台
                ConfirmSaveImport();
            });  

        }

</script>

<!--添加对uploadify控件的支持-->
<script type="text/javascript">
        $(function () {
            //添加界面的附件管理
            $('#file_upload').uploadify({
                'swf': '/Content/JQueryTools/uploadify/uploadify.swf',  //FLash文件路径
                'buttonText': '浏  览',                                 //按钮文本
                'uploader': '/FileUpload/Upload',                       //处理上传的页面
                'queueID': 'fileQueue',                         //队列的ID
                'queueSizeLimit': 1,                            //队列最多可上传文件数量，默认为999
                'auto': false,                                  //选择文件后是否自动上传，默认为true
                'multi': false,                                 //是否为多选，默认为true
                'removeCompleted': true,                        //是否完成后移除序列，默认为true
                'fileSizeLimit': '10MB',                        //单个文件大小，0为无限制，可接受KB,MB,GB等单位的字符串值
                'fileTypeDesc': 'Excel Files',                  //文件描述
                'fileTypeExts': '*.xls',                        //上传的文件后缀过滤器
                'onQueueComplete': function (event, data) {     //所有队列完成后事件

                    var guid = $("#AttachGUID").val();
                    ViewUpFiles(guid, "div_files");

                    //提示用户Excel格式是否正常，如果正常加载数据
                    $.ajax({
                        url: '/User/CheckExcelColumns?guid=' + guid,
                        type: 'get',
                        dataType: 'json',
                        success: function (data) {
                            if (data.Success) {
                                InitGrid(); //重新刷新表格数据
                                showToast("文件已上传，数据加载完毕！");
                            }
                            else {
                                showToast("上传的Excel文件检查不通过。请根据页面右上角的Excel模板格式进行数据录入。", "error");
                            }
                        }
                    });
                },
                'onUploadStart': function (file) {
                    InitUpFile();//上传文件前 ，重置GUID，每次不同
                    $("#file_upload").uploadify("settings", 'formData', { 'folder': '数据导入文件', 'guid': $("#AttachGUID").val() }); //动态传参数
                },
                'onUploadError': function (event, queueId, fileObj, errorObj) {
                    //alert(errorObj.type + "：" + errorObj.info);
                }
            });
        });

        var attachguid = "";//用来记录附件组的ID，方便更新
        function InitUpFile() {
            //新增的时候，绑定附件显示
            var guid = newGuid();
            $("#AttachGUID").val(guid);
            attachguid = guid;
            ViewUpFiles(attachguid, "div_files");//更新列表
        }

        //删除指定的附件后，对附件组进行更新
        function deleteAttach(id) {
            DeleteAndRefreshAttach(id, attachguid, "div_files");
        }

        //根据条件查询并绑定结果
        function InitGrid() {
            var guid = $("#AttachGUID").val();
            var url = "/User/GetExcelData?guid=" + guid;
            $.getJSON(url, function (data) {
                $("#gridImport_body").html("");

                $.each(data.rows, function (i, item) {
                    var tr = "<tr>";
                    tr += "<td><input class='checkboxes' type=\"checkbox\" name=\"checkbox\" ></td>";
                    tr += "<td>" + item.UserCode + "</td>";
                    tr += "<td>" + item.Name + "</td>";
                    tr += "<td>" + item.FullName + "</td>";   
                    tr += "<td>" + item.Title + "</td>";
                    tr += "<td>" + item.MobilePhone + "</td>";
                    tr += "<td>" + item.OfficePhone + "</td>";
                    tr += "<td>" + item.Email + "</td>";
                    tr += "<td>" + item.Gender + "</td>";
                    tr += "<td>" + item.QQ + "</td>";
                    tr += "<td>" + item.Note + "</td>";

                    tr += "</tr>";
                    $("#gridImport_body").append(tr);
                });
            });
        }

        //保存导入的数据
        function SaveImport() {
            //赋值给对象
            $("#Company_ID3").select2("val", @Session["Company_ID"]).trigger('change');
            $("#Dept_ID3").select2("val", @Session["Dept_ID"]).trigger('change');


            $("#selectDept").modal("show");
        }

        //选择公司部门后，确认保存导入
        function ConfirmSaveImport() {
            
            var list = [];//构造集合对象
            var i = 0;
            var bodyTag = "#gridImport_body";
            $(bodyTag +" tr").each(function() {
                //判断是否选中，选中的记录才导入数据库
                var checkbox = $(this).find("td").find(".checkboxes");

                if (checkbox!=undefined && $(checkbox).is(':checked')) {                    
                    //遍历每个TD，获取内容，并添加进列表
                    var rows = [];
                    $(this).find('td:not(:first-child)').each (function() {
                        rows.push($(this).text());
                        // alert($(this).text());
                    });    

                    list.push({ 'UserCode': rows[0],  'Name': rows[1], 'FullName': rows[2], 'Title': rows[3], 
                        'MobilePhone': rows[4], 'OfficePhone': rows[5], 'Email': rows[6], 'Gender': rows[7], 
                        'QQ': rows[8], 'Note': rows[9] });
                    i++;
                }
            });

            if (list.length == 0) {
                showToast("请选择一条记录", "warning");
                return;
            }

            var companyid = $("#Company_ID3").val();
            var deptid = $("#Dept_ID3").val();

            var postData = { 'list': list, 'companyid': companyid, deptid: deptid };
            postData = JSON.stringify(postData);

            $.ajax({
                url: '/User/SaveExcelData',
                type: 'post',
                dataType: 'json',
                contentType: 'application/json;charset=utf-8',
                traditional: true,
                success: function (data) {
                    if (data.Success) {
                        //保存成功  1.关闭弹出层，2.清空记录显示 3.刷新主列表
                        showToast("保存成功");

                        $("#import").modal("hide");
                        $(bodyTag).html("");
                        Refresh();
                    }
                    else {
                        showToast("保存失败:" + data.ErrorMessage, "error");
                    }
                },
                data: postData
            });
        }
</script>

}
